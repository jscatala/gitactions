name: Build all or based on changes

on:
    workflow_dispatch:
        inputs:
            build_all:
                description: 'Build all services?'
                required: true
                type: boolean
            
            sha:
                description: 'Sha to test'
                required: true
                type: string


jobs:
    show-diff:
        if: ${{ inputs.build_all }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0 # Must be changed to 2 once test finish

            - name: Show files changed in the commit
              id: service-matrix
              run: |
                echo "Changed files in commit ${{ inputs.sha }}:" 
                services=( $(git diff-tree --no-commit-id --name-only -r ${{ inputs.sha }} | grep -E "^services/*" | cut -d'/' -f2 | uniq) )
                echo "value=$services" >> $GITHUB_OUTPUT
            
            - name: Output
              run: echo "${{ steps.service-matrix.outputs.value }}"
        
     split-build:
        runs-on: ubuntu-latest
        needs: show-diff
        strategy:
            matrix:
                value: ${{fromJSON(needs.show-diff.outputs.service-matrix)}}
        steps:
            - run: |
                echo "${{ matrix.value }}"
